@{
    ViewData["Title"] = "Company Management";
    Layout = "_AdminLayout";
}

<style>
    :root {
        --primary: #4361ee;
        --primary-light: rgba(67, 97, 238, 0.1);
        --primary-dark: #3a56e8;
        --success: #10b981;
        --success-light: rgba(16, 185, 129, 0.1);
        --danger: #ef4444;
        --danger-light: rgba(239, 68, 68, 0.1);
        --warning: #f59e0b;
        --warning-light: rgba(245, 158, 11, 0.1);
        --secondary: #6b7280;
        --light-bg: #f8fafc;
        --dark-text: #1e293b;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --hover-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    * {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .company-management-container {
        background-color: var(--light-bg);
        min-height: 100vh;
        padding: 1.5rem;
    }

    /* Header Section */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--dark-text);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-title i {
        color: var(--primary);
        font-size: 1.5rem;
    }

    /* Stats Cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border-left: 4px solid var(--primary);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--hover-shadow);
    }

    .stat-card.pending {
        border-left-color: var(--warning);
    }

    .stat-card.verified {
        border-left-color: var(--success);
    }

    .stat-card.rejected {
        border-left-color: var(--danger);
    }

    .stat-card.total {
        border-left-color: var(--primary);
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--secondary);
        font-weight: 500;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.75rem;
    }

    .stat-icon.total {
        background: var(--primary-light);
        color: var(--primary);
    }

    .stat-icon.pending {
        background: var(--warning-light);
        color: var(--warning);
    }

    .stat-icon.verified {
        background: var(--success-light);
        color: var(--success);
    }

    .stat-icon.rejected {
        background: var(--danger-light);
        color: var(--danger);
    }

    /* Main Card */
    .main-card {
        background: white;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: var(--dark-text);
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Button Styles */
    .btn {
        border-radius: 8px;
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
    }

    .btn-outline-success {
        background-color: transparent;
        border: 1px solid var(--success);
        color: var(--success);
    }

    .btn-outline-success:hover {
        background-color: var(--success);
        color: white;
    }

    .btn-outline-danger {
        background-color: transparent;
        border: 1px solid var(--danger);
        color: var(--danger);
    }

    .btn-outline-danger:hover {
        background-color: var(--danger);
        color: white;
    }

    .btn-success {
        background-color: var(--success);
        color: white;
    }

    .btn-danger {
        background-color: var(--danger);
        color: white;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    /* Filter Section */
    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--card-shadow);
    }

    .filter-row {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--dark-text);
    }

    .form-select, .form-control {
        border-radius: 8px;
        padding: 0.625rem 1rem;
        border: 1px solid #e2e8f0;
        width: 100%;
        transition: all 0.2s ease;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    /* Grid Styles */
    .k-grid {
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .k-grid-header {
        background-color: #f8fafc;
    }

    .k-grid-content {
        background: white;
    }

    .k-grid tr {
        transition: background-color 0.2s ease;
    }

    .k-grid tr:hover {
        background-color: rgba(67, 97, 238, 0.04);
    }

    /* Badges */
    .badge {
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .bg-success {
        background-color: var(--success) !important;
    }

    .bg-danger {
        background-color: var(--danger) !important;
    }

    .bg-warning {
        background-color: var(--warning) !important;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s ease;
        border: none;
        background: transparent;
    }

    .action-btn.view {
        color: var(--primary);
        background: var(--primary-light);
    }

    .action-btn.approve {
        color: var(--success);
        background: var(--success-light);
    }

    .action-btn.reject {
        color: var(--danger);
        background: var(--danger-light);
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Modal Styles */
    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .modal-header {
        background: linear-gradient(135deg, var(--primary), #5a6cea);
        color: white;
        border-radius: 16px 16px 0 0 !important;
        padding: 1.5rem;
    }

    .modal-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        border-top: 1px solid #e2e8f0;
        padding: 1.25rem 1.5rem;
    }

    .btn-close-white {
        filter: invert(1);
    }

    /* Company Details */
    .company-header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .company-logo {
        height: 80px;
        width: 80px;
        object-fit: contain;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        padding: 0.5rem;
        background: white;
        margin-bottom: 1rem;
    }

    .company-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        color: var(--dark-text);
    }

    .company-industry {
        color: var(--secondary);
        font-size: 0.875rem;
    }

    .company-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .detail-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 8px;
    }

    .detail-icon {
        width: 20px;
        color: var(--primary);
        margin-top: 0.125rem;
    }

    .detail-content {
        flex: 1;
    }

    .detail-label {
        font-size: 0.75rem;
        color: var(--secondary);
        margin-bottom: 0.25rem;
    }

    .detail-value {
        font-weight: 500;
        color: var(--dark-text);
    }

    /* Document Preview */
    .documents-section {
        margin-top: 1.5rem;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }

    .doc-card {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .doc-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        border-color: var(--primary);
    }

    .doc-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-light);
        border-radius: 8px;
        color: var(--primary);
        font-size: 1.25rem;
    }

    .doc-info {
        flex: 1;
    }

    .doc-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
        color: var(--dark-text);
    }

    .doc-meta {
        font-size: 0.75rem;
        color: var(--secondary);
    }

    .doc-preview-btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        background: var(--primary);
        color: white;
        border: none;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .doc-preview-btn:hover {
        background: var(--primary-dark);
        color: white;
        transform: translateY(-2px);
    }

    .no-docs {
        text-align: center;
        padding: 2rem;
        color: var(--secondary);
        background: #f8fafc;
        border-radius: 10px;
        border: 1px dashed #e2e8f0;
    }

    /* Bulk Actions */
    .bulk-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Responsive Adjustments */
    @@media (max-width: 1200px) {
        .stats-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .company-management-container {
            padding: 1rem;
        }
        
        .stats-container {
            grid-template-columns: 1fr;
        }
        
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .bulk-actions {
            width: 100%;
            margin-top: 1rem;
        }
        
        .card-header {
            padding: 1rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .filter-row {
            flex-direction: column;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .company-details {
            grid-template-columns: 1fr;
        }
        
        .documents-grid {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .action-btn {
            width: 100%;
            height: 36px;
        }
    }

    /* Kendo Grid Customizations */
    .k-pager-numbers .k-link.k-state-selected {
        color: white;
        background-color: var(--primary);
    }

    .k-pager-numbers .k-link {
        color: var(--primary);
    }

    .k-pager-numbers .k-link:hover {
        color: white;
        background-color: var(--primary-dark);
    }

    .k-grid-header .k-grid-filter.k-state-active,
    .k-grid-header .k-header-column-menu.k-state-active,
    .k-grid-header .k-hierarchy-cell .k-icon.k-state-active {
        color: var(--primary);
        background-color: var(--primary-light);
    }

    .k-grid .k-checkbox:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
</style>

<div class="company-management-container">
    <!-- Stats Overview -->
    <div class="stats-container">
        <div class="stat-card total">
            <div class="stat-icon total">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-value" id="totalCompanies">0</div>
            <div class="stat-label">Total Companies</div>
        </div>
        <div class="stat-card pending">
            <div class="stat-icon pending">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value" id="pendingCompanies">0</div>
            <div class="stat-label">Pending Review</div>
        </div>
        <div class="stat-card verified">
            <div class="stat-icon verified">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-value" id="verifiedCompanies">0</div>
            <div class="stat-label">Verified</div>
        </div>
        <div class="stat-card rejected">
            <div class="stat-icon rejected">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-value" id="rejectedCompanies">0</div>
            <div class="stat-label">Rejected</div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="main-card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-list-alt me-2"></i>Company List
            </h5>
            <div class="bulk-actions">
                <button type="button" class="btn btn-outline-success" id="bulkApproveBtn">
                    <i class="fas fa-check-double me-1"></i>Bulk Approve
                </button>
                <button type="button" class="btn btn-outline-danger" id="bulkRejectBtn">
                    <i class="fas fa-times me-1"></i>Bulk Reject
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Filters -->
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="form-label">Verification Status</label>
                        <select class="form-select" id="verificationFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="true">Verified</option>
                            <option value="false">Rejected</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Industry</label>
                        <select class="form-select" id="industryFilter">
                            <option value="">All Industries</option>
                            <option value="Technology">Technology</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Finance">Finance</option>
                            <option value="Education">Education</option>
                            <option value="Manufacturing">Manufacturing</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Registration Date</label>
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                    <div class="filter-group">
                        <button type="button" class="btn btn-primary w-100" id="applyFilters">
                            <i class="fas fa-filter me-1"></i>Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Companies Grid -->
            <div id="companiesGrid"></div>
        </div>
    </div>
</div>

<!-- Company Details Modal -->
<div class="modal fade" id="companyDetailsModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building me-2"></i> Company Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="company-header">
                    <img id="modalCompanyLogo" src="" alt="Company Logo" class="company-logo">
                    <h3 id="modalCompanyName" class="company-name"></h3>
                    <p id="modalCompanyIndustry" class="company-industry"></p>
                </div>

                <div class="company-details">
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Email</div>
                            <div id="modalCompanyEmail" class="detail-value"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Phone</div>
                            <div id="modalCompanyPhone" class="detail-value"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Address</div>
                            <div id="modalCompanyAddress" class="detail-value"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Registration Number</div>
                            <div id="modalCompanyRegNumber" class="detail-value"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Tax ID</div>
                            <div id="modalCompanyTaxId" class="detail-value"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-icon">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="detail-content">
                            <div class="detail-label">Website</div>
                            <div id="modalCompanyWebsite" class="detail-value"></div>
                        </div>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <p class="mb-0"><strong>Verification Status:</strong> <span id="companyStatus" class="badge"></span></p>
                </div>

                <!-- Legal Documents Preview Section -->
                <div class="documents-section">
                    <h6 class="section-title">
                        <i class="fas fa-file-alt me-2"></i>Legal Documents
                    </h6>
                    <div class="documents-grid" id="legalDocsPreview">
                        <!-- Documents will be displayed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success me-2" id="approveCompany">
                    <i class="fas fa-check-circle me-1"></i> Approve
                </button>
                <button type="button" class="btn btn-danger" id="rejectCompany">
                    <i class="fas fa-ban me-1"></i> Reject
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            var selectedCompanyId = null;

            // Initialize stats
            function updateStats(data) {
                var total = data.length;
                var pending = data.filter(item => item.c_verified_status === null).length;
                var verified = data.filter(item => item.c_verified_status === true).length;
                var rejected = data.filter(item => item.c_verified_status === false).length;
                
                $("#totalCompanies").text(total);
                $("#pendingCompanies").text(pending);
                $("#verifiedCompanies").text(verified);
                $("#rejectedCompanies").text(rejected);
            }

            var grid = $("#companiesGrid").kendoGrid({
                dataSource: {
                    transport: {
                        read: {
                            url: "http://localhost:5086/api/AdminApi/getrecruiter",
                            dataType: "json"
                        }
                    },
                    schema: {
                        model: {
                            id: "c_company_id",
                            fields: {
                                c_company_id: { type: "number" },
                                c_company_name: { type: "string" },
                                c_owner_id: { type: "number" },
                                c_company_email: { type: "string" },
                                c_company_phone: { type: "string" },
                                c_company_address: { type: "string" },
                                c_company_reg_number: { type: "string" },
                                c_tax_id_number: { type: "string" },
                                c_industry: { type: "string" },
                                c_website: { type: "string" },
                                c_verified_status: { type: "boolean" },
                                c_legal_documents: { type: "object" },
                                c_company_logo: { type: "string" },
                                c_created_at: { type: "date" }
                            }
                        }
                    },
                    pageSize: 10,
                    change: function(e) {
                        if (this.view().length > 0) {
                            updateStats(this.view());
                        }
                    }
                },
                columns: [
                    {
                        selectable: true,
                        width: "50px",
                        headerTemplate: '<input type="checkbox" id="selectAllCheckbox" class="k-checkbox">',
                        template: function(dataItem) {
                            return '<input type="checkbox" class="rowCheckbox k-checkbox" data-id="' + dataItem.c_company_id + '" />';
                        },
                        attributes: { "class": "text-center" }
                    },
                    {
                        field: "c_company_logo",
                        title: "Logo",
                        template: function (dataItem) {
                            return dataItem.c_company_logo
                                ? `<img src="${dataItem.c_company_logo}" alt="Logo" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px;">`
                                : '<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 6px;"><i class="fas fa-building" style="color: #94a3b8;"></i></div>';
                        },
                        width: "70px",
                        attributes: { "class": "text-center" }
                    },
                    {
                        field: "c_company_name",
                        title: "Company Name",
                        template: '<div class="fw-semibold">#: c_company_name #</div><div class="text-muted small">#: c_industry || "N/A" #</div>'
                    },
                    {
                        field: "c_company_email",
                        title: "Contact",
                        template: '<div>#: c_company_email #</div><div class="text-muted small">#: c_company_phone || "N/A" #</div>'
                    },
                    {
                        field: "c_created_at",
                        title: "Registered",
                        template: function(dataItem) {
                            if (dataItem.c_created_at) {
                                var date = new Date(dataItem.c_created_at);
                                return kendo.toString(date, 'MMM dd, yyyy');
                            }
                            return "N/A";
                        },
                        width: "120px"
                    },
                    {
                        field: "c_verified_status",
                        title: "Status",
                        template: function (dataItem) {
                            if (dataItem.c_verified_status === null) {
                                return '<span class="badge bg-warning">Pending</span>';
                            } else if (dataItem.c_verified_status) {
                                return '<span class="badge bg-success">Verified</span>';
                            } else {
                                return '<span class="badge bg-danger">Rejected</span>';
                            }
                        },
                        width: "100px",
                        attributes: { "class": "text-center" }
                    },
                    {
                        title: "Actions",
                        template: function (dataItem) {
                            return `
                                <div class="action-buttons">
                                    <button class="action-btn view" data-id="${dataItem.c_company_id}" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn approve" data-id="${dataItem.c_company_id}" title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="action-btn reject" data-id="${dataItem.c_company_id}" title="Reject">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>`;
                        },
                        width: "140px",
                        attributes: { "class": "text-center" }
                    }
                ],
                toolbar: ["search"],
                search: {
                    fields: [
                        { name: "c_company_name", operator: "contains" },
                        { name: "c_company_email", operator: "contains" },
                        { name: "c_company_phone", operator: "contains" }
                    ]
                },
                resizable: true,
                selectable: "multiple, row",
                pageable: {
                    pageSizes: [10, 25, 50],
                    buttonCount: 5,
                    messages: {
                        display: "Showing {0}-{1} of {2} items",
                        empty: "No companies found",
                        itemsPerPage: "items per page"
                    }
                },
                height: 600,
                noRecords: {
                    template: '<div class="text-center p-4 text-muted"><i class="fas fa-building fa-2x mb-3"></i><p>No companies found matching your criteria</p></div>'
                },
                dataBound: function () {
                    // Handle select all checkbox
                    $('#selectAllCheckbox').off('change').on('change', function () {
                        var isChecked = $(this).prop('checked');
                        $('.rowCheckbox').prop('checked', isChecked);
                    });

                    // Handle individual checkbox changes
                    $('.rowCheckbox').off('change').on('change', function () {
                        var totalCheckboxes = $('.rowCheckbox').length;
                        var checkedCheckboxes = $('.rowCheckbox:checked').length;
                        
                        if (checkedCheckboxes === 0) {
                            $('#selectAllCheckbox').prop('checked', false);
                        } else if (checkedCheckboxes === totalCheckboxes) {
                            $('#selectAllCheckbox').prop('checked', true);
                        }
                    });

                    // Attach event handlers to action buttons
                    $(".approve").click(handleApproveClick);
                    $(".reject").click(handleRejectClick);
                    $(".view").click(handleViewDetailsClick);
                }
            }).data("kendoGrid");

            function handleApproveClick() {
                var companyId = $(this).data("id");
                if (companyId) {
                    Swal.fire({
                        title: 'Approve Company',
                        text: 'Are you sure you want to approve this Company?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, Approve',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            updateRecruiterStatus(companyId, true);
                        }
                    });
                }
            }

            function handleRejectClick() {
                var companyId = $(this).data("id");
                if (companyId) {
                    Swal.fire({
                        title: 'Reject Company',
                        html: '<div class="form-group text-start">' +
                            '<label for="rejectReason" class="form-label">Reason for Rejection:</label>' +
                            '<textarea id="rejectReason" class="form-control" rows="3" placeholder="Please specify the reason for rejection..." required></textarea>' +
                            '</div>',
                        showCancelButton: true,
                        confirmButtonText: 'Reject',
                        cancelButtonText: 'Cancel',
                        focusConfirm: false,
                        preConfirm: () => {
                            const reason = $('#rejectReason').val();
                            if (!reason) {
                                Swal.showValidationMessage('Please provide a reason for rejection');
                                return false;
                            }
                            return reason;
                        }
                    }).then((result) => {
                        if (result.isConfirmed && result.value) {
                            updateRecruiterStatus(companyId, false, result.value);
                        }
                    });
                }
            }

            function handleViewDetailsClick() {
                var companyId = $(this).data("id");
                var dataItem = grid.dataSource.get(companyId);
                if (dataItem) {
                    selectedCompanyId = companyId;
                    showCompanyDetails(dataItem);
                }
            }

            function showCompanyDetails(company) {
                // Set basic company info
                $("#modalCompanyName").text(company.c_company_name || "N/A");
                $("#modalCompanyEmail").text(company.c_company_email || "N/A");
                $("#modalCompanyPhone").text(company.c_company_phone || "N/A");
                $("#modalCompanyAddress").text(company.c_company_address || "N/A");
                $("#modalCompanyRegNumber").text(company.c_company_reg_number || "N/A");
                $("#modalCompanyTaxId").text(company.c_tax_id_number || "N/A");
                $("#modalCompanyIndustry").text(company.c_industry || "N/A");
                $("#modalCompanyWebsite").text(company.c_website || "N/A");

                // Set company logo
                const logoImg = $("#modalCompanyLogo");
                if (company.c_company_logo) {
                    logoImg.attr("src", company.c_company_logo).show();
                } else {
                    logoImg.hide();
                }

                // Set status badge
                const statusBadge = $("#companyStatus");
                statusBadge.removeClass("bg-warning bg-success bg-danger");

                if (company.c_verified_status === null) {
                    statusBadge.addClass("bg-warning").text("Pending");
                    $("#approveCompany, #rejectCompany").show();
                } else if (company.c_verified_status) {
                    statusBadge.addClass("bg-success").text("Verified");
                    $("#approveCompany, #rejectCompany").hide();
                } else {
                    statusBadge.addClass("bg-danger").text("Rejected");
                    $("#approveCompany, #rejectCompany").show();
                }

                // Display legal documents
                const legalDocsPreview = $("#legalDocsPreview");
                if (company.c_legal_documents && company.c_legal_documents.length > 0) {
                    const docsHtml = company.c_legal_documents.map(doc => `
                                        <div class="doc-card">
                                            <div class="doc-icon">
                                                <i class="fas fa-file-pdf"></i>
                                            </div>
                                            <div class="doc-info">
                                                <div class="doc-name">${doc.split('/').pop()}</div>
                                                <div class="doc-meta">PDF Document</div>
                                            </div>
                                            <button class="doc-preview-btn" data-doc-url="${doc}">
                                                <i class="fas fa-eye"></i> Preview
                                            </button>
                                        </div>
                                    `).join('');
                    legalDocsPreview.html(docsHtml);
                } else {
                    legalDocsPreview.html(`
                                        <div class="no-docs">
                                            <i class="fas fa-folder-open fa-2x mb-3"></i>
                                            <p>No legal documents available</p>
                                        </div>
                                    `);
                }

                $("#companyDetailsModal").modal("show");
            }

            $("#applyFilters").click(function () {
                var verification = $("#verificationFilter").val();
                var industry = $("#industryFilter").val();
                var date = $("#dateFilter").val();
                
                var dataSource = grid.dataSource;
                var filters = [];

                if (verification !== "") {
                    if (verification === "pending") {
                        filters.push({ field: "c_verified_status", operator: "eq", value: null });
                    } else {
                        filters.push({ field: "c_verified_status", operator: "eq", value: verification === "true" });
                    }
                }

                if (industry !== "") {
                    filters.push({ field: "c_industry", operator: "contains", value: industry });
                }

                if (date !== "") {
                    filters.push({ field: "c_created_at", operator: "gte", value: new Date(date) });
                }

                dataSource.filter(filters);
            });

            function getSelectedCompanyIds() {
                var selectedIds = [];
                
                // Use a more reliable method to get checked checkboxes
                $('input.rowCheckbox:checked').each(function() {
                    var id = $(this).data('id');
                    if (id) {
                        selectedIds.push(id);
                    }
                });
                
                // Log the selected IDs for debugging
                console.log("Selected IDs:", selectedIds);
                
                return selectedIds;
            }

            function updateRecruiterStatus(companyId, isApproved, reason = null) {
                var apiUrl = isApproved
                    ? `http://localhost:5086/api/AdminApi/updaterecruiterstatus/${companyId}?approved=true`
                    : `http://localhost:5086/api/AdminApi/updaterecruiterstatusReject/${companyId}?reason=${encodeURIComponent(reason)}&approved=false`;

                $.ajax({
                    url: apiUrl,
                    type: "PUT",
                    contentType: "application/json",
                    success: function () {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: isApproved ? 'Company approved successfully.' : 'Company rejected successfully.',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        grid.dataSource.read();
                        if (!isApproved) {
                            $("#companyDetailsModal").modal("hide");
                        }
                    },
                    error: function (xhr) {
                        console.error('Error response:', xhr.responseText);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: xhr.responseText || 'An error occurred while updating the company status.'
                        });
                    }
                });
            }

            $("#approveCompany").click(function () {
                if (selectedCompanyId) {
                    Swal.fire({
                        title: 'Approve Company',
                        text: 'Are you sure you want to approve this company?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, Approve',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            updateRecruiterStatus(selectedCompanyId, true);
                            $("#companyDetailsModal").modal("hide");
                        }
                    });
                }
            });

            $("#rejectCompany").click(function () {
                if (selectedCompanyId) {
                    Swal.fire({
                        title: 'Reject Company',
                        html: '<div class="form-group text-start">' +
                            '<label for="rejectReason" class="form-label">Reason for Rejection:</label>' +
                            '<textarea id="rejectReason" class="form-control" rows="3" placeholder="Please specify the reason for rejection..." required></textarea>' +
                            '</div>',
                        showCancelButton: true,
                        confirmButtonText: 'Reject',
                        cancelButtonText: 'Cancel',
                        focusConfirm: false,
                        preConfirm: () => {
                            const reason = $('#rejectReason').val();
                            if (!reason) {
                                Swal.showValidationMessage('Please provide a reason for rejection');
                                return false;
                            }
                            return reason;
                        }
                    }).then((result) => {
                        if (result.isConfirmed && result.value) {
                            updateRecruiterStatus(selectedCompanyId, false, result.value);
                            $("#companyDetailsModal").modal("hide");
                        }
                    });
                }
            });

            $("#bulkApproveBtn").click(function () {
                // Get selected IDs directly from the grid
                var selectedRows = grid.select();
                var selectedIds = [];
                
                selectedRows.each(function() {
                    var dataItem = grid.dataItem(this);
                    if (dataItem && dataItem.c_company_id) {
                        selectedIds.push(dataItem.c_company_id);
                    }
                });
                
                // Log the selected IDs for debugging
                console.log("Bulk approve clicked. Selected IDs:", selectedIds);
                
                if (selectedIds.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Selection',
                        text: 'Please select at least one company to approve.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    return;
                }

                Swal.fire({
                    title: "Bulk Approve Companies",
                    text: `You are about to approve ${selectedIds.length} company(s). Continue?`,
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "Yes, Approve All",
                    cancelButtonText: "Cancel"
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "http://localhost:5086/api/AdminApi/bulkupdaterecruiterstatus?approved=true",
                            type: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify(selectedIds),
                            success: function () {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: `${selectedIds.length} company(s) approved successfully.`,
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                                grid.dataSource.read();
                            },
                            error: function (xhr) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: xhr.responseText || 'An error occurred during bulk approval.'
                                });
                            }
                        });
                    }
                });
            });

            $("#bulkRejectBtn").click(function () {
                // Get selected IDs directly from the grid
                var selectedRows = grid.select();
                var selectedIds = [];
                
                selectedRows.each(function() {
                    var dataItem = grid.dataItem(this);
                    if (dataItem && dataItem.c_company_id) {
                        selectedIds.push(dataItem.c_company_id);
                    }
                });
                
                // Log the selected IDs for debugging
                console.log("Bulk reject clicked. Selected IDs:", selectedIds);
                
                if (selectedIds.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Selection',
                        text: 'Please select at least one company to reject.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    return;
                }

                Swal.fire({
                    title: 'Bulk Reject Companies',
                    html: '<div class="form-group text-start">' +
                        '<label for="rejectReason" class="form-label">Reason for Rejection:</label>' +
                        '<textarea id="rejectReason" class="form-control" rows="3" placeholder="Please specify the reason for rejection..." required></textarea>' +
                        '</div>',
                    showCancelButton: true,
                    confirmButtonText: 'Reject All',
                    cancelButtonText: 'Cancel',
                    focusConfirm: false,
                    preConfirm: () => {
                        const reason = $('#rejectReason').val();
                        if (!reason) {
                            Swal.showValidationMessage('Please provide a reason for rejection');
                            return false;
                        }
                        return reason;
                    }
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        $.ajax({
                            url: `http://localhost:5086/api/AdminApi/bulkupdaterecruiterstatusreject?reason=${encodeURIComponent(result.value)}&approved=false`,
                            type: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify(selectedIds),
                            success: function () {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: `${selectedIds.length} company(s) rejected successfully.`,
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                                grid.dataSource.read();
                            },
                            error: function (xhr) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: xhr.responseText || 'An error occurred during bulk rejection.'
                                });
                            }
                        });
                    }
                });
            });

            // Document preview handler
            $(document).on('click', '.doc-preview-btn', function (e) {
                e.preventDefault();
                var docUrl = $(this).data('doc-url');

                if (!docUrl) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Document URL is not available'
                    });
                    return;
                }

                // For PDF files, show options to view or download
                if (docUrl.toLowerCase().endsWith('.pdf')) {
                    Swal.fire({
                        title: 'Document Preview',
                        html: `
                                            <div class="text-center">
                                                <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                                                <p>This document is stored externally.</p>
                                                <div class="d-flex justify-content-center gap-2 mt-3">
                                                    <a href="${docUrl}" target="_blank" class="btn btn-primary">
                                                        <i class="fas fa-external-link-alt me-1"></i>Open
                                                    </a>
                                                    <a href="${docUrl}" download class="btn btn-success">
                                                        <i class="fas fa-download me-1"></i>Download
                                                    </a>
                                                </div>
                                            </div>`,
                        showConfirmButton: false,
                        showCloseButton: true
                    });
                } else {
                    // For other file types, open in new tab
                    window.open(docUrl, '_blank');
                }
            });
        });
    </script>
}